<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程列表 - 学生选课系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            margin-top: 20px;
        }
        .mb-3 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-3">课程查询（学期：<span id="formatted-semester">{{ semester | format_semester }}</span>）</h1>
        <!-- 查询表单 -->
        <form id="searchForm" class="mb-3">
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="searchInput" placeholder="输入课程名、编号或教师姓名查询">
                <button class="btn btn-primary" type="submit">搜索</button>
            </div>
        </form>

        <!-- 课程列表 -->
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">课程ID</th>
                    <th scope="col">课程名称</th>
                    <th scope="col">学分</th>
                    <th scope="col">院系</th>
                    <th scope="col">教师</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody id="course-table-body">
                <!-- 课程数据将在这里动态插入 -->
            </tbody>
        </table>

        <h2 class="mb-3">已选课程</h2>
        <!-- 已选课程列表 -->
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th scope="col">课程ID</th>
                    <th scope="col">课程名称</th>
                    <th scope="col">上课时间</th>
                    <th scope="col">任课教师</th>
                    <th scope="col">教师编号</th>
                    <th scope="col">学分</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody id="selected-course-table-body">
                <!-- 已选课程数据将在这里动态插入 -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6" style="text-align: right;">总学分：</td>
                    <td id="total-credits"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            fetchCourses(); // 载入课程数据
            fetchSelectedCourses(); // 载入已选课程数据

            // 处理搜索表单提交
            $('#searchForm').submit(function(event) {
                event.preventDefault();
                fetchCourses($('#searchInput').val());
            });
        });

        function fetchCourses(query='') {
            $.ajax({
                url: `/api/courses?semester={{ semester }}&query=${query}`,
                type: 'GET',
                success: function(data) {
                    $('#course-table-body').empty();
                    data.forEach(function(course, index) {
                        $('#course-table-body').append(`
                            <tr>
                                <th scope="row">${index + 1}</th>
                                <td>${course.course_id}</td>
                                <td>${course.course_name}</td>
                                <td>${course.credit}</td>
                                <td>${course.dept_name}</td>
                                <td>${course.teacher_name}</td>
                                <td>
                                    <button class="btn btn-primary enroll-btn" data-course-id="${course.course_id}">选课</button>
                                </td>
                            </tr>
                        `);
                    });
                },
                error: function() {
                    $('#course-table-body').append('<tr><td colspan="7">无法加载课程信息</td></tr>');
                }
            });
        }

        function fetchSelectedCourses() {
            $.ajax({
                url: '/api/selected_courses?semester={{ semester }}',
                type: 'GET',
                success: function(data) {
                    $('#selected-course-table-body').empty();
                    var totalCredits = 0;
                    data.forEach(function(course) {
                        $('#selected-course-table-body').append(`
                            <tr>
                                <td>${course.course_id}</td>
                                <td>${course.course_name}</td>
                                <td>${course.class_time}</td>
                                <td>${course.teacher_name}</td>
                                <td>${course.staff_id}</td>
                                <td>${course.credit}</td>
                                <td>
                                    <button class="btn btn-danger drop-btn" data-course-id="${course.course_id}">退课</button>
                                </td>
                            </tr>
                        `);
                        totalCredits += parseInt(course.credit);
                    });
                    $('#total-credits').text(totalCredits);
                },
                error: function() {
                    $('#selected-course-table-body').append('<tr><td colspan="7">加载已选课程信息失败</td></tr>');
                }
            });
        }

        $(document).on('click', '.enroll-btn', function() {
            var courseId = $(this).data('course-id');
            enrollCourse(courseId);
        });

        $(document).on('click', '.drop-btn', function() {
            var courseId = $(this).data('course-id');
            dropCourse(courseId);
        });

        function enrollCourse(courseId) {
            $.ajax({
                url: '/enroll_course',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ course_id: courseId, semester: "{{ semester }}" }),
                success: function(response) {
                    if (response.success) {
                        alert('选课成功！');
                        location.reload();  // Reload the page to update the lists
                    } else {
                        alert('选课失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('选课请求失败。');
                }
            });
        }

        function dropCourse(courseId) {
            $.ajax({
                url: '/drop_course',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ course_id: courseId, semester: "{{ semester }}" }),
                success: function(response) {
                    if (response.success) {
                        alert('退课成功！');
                        location.reload();  // Reload the page to update the lists
                    } else {
                        alert('退课失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('退课请求失败。');
                }
            });
        }
    </script>
</body>
</html>
